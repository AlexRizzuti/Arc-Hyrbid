<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Alex Pro ‚Äî Hybrid Coach</title>
<meta name="theme-color" content="#0E1014">
<style>
/* =========== THEME (Pro Look) =========== */
:root{
  --bg:#0E1014; --elev:#141824; --card:#171C29; --ink:#EAF0FF; --muted:#9AA3B2; --line:#242A39;
  --brand:#6AA7FF; --brand2:#7BD0FF; --accent:#62E0A6; --warn:#FFC266; --danger:#FF6B6B;
  --ring:#233147; --ring2:#3A79FF;
  --radius:16px; --radius-sm:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
}
:root[data-theme="light"]{
  --bg:#F6F8FD; --elev:#F9FBFF; --card:#FFFFFF; --ink:#0B1020; --muted:#5E6A7E; --line:#E7ECF5;
  --brand:#2E6CF6; --brand2:#67AFFA; --accent:#20C781; --warn:#E59F2A; --danger:#E34B4B;
  --ring:#DAE6FF; --ring2:#2E6CF6;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,var(--bg),#0B0D12 55%);
  color:var(--ink);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Inter, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
a{color:inherit}

/* =========== LAYOUT =========== */
.app{max-width:1100px;margin:0 auto; padding:16px 16px 84px}
.topbar{
  display:flex; align-items:center; gap:12px; margin:6px 0 14px;
}
.brand{display:flex; align-items:center; gap:10px}
.logo{
  width:36px; height:36px; border-radius:12px;
  background: radial-gradient(120% 120% at 0% 0%, var(--brand2), var(--brand));
  box-shadow:0 6px 18px rgba(96,160,255,.35);
}
h1{font-size:22px; line-height:1.15; margin:0}
.badge{padding:4px 10px; border-radius:999px; background:var(--card); color:var(--muted); border:1px solid var(--line); font-size:12px}
.spacer{flex:1}
.toggle{display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:var(--card)}

.tabs{
  display:flex; gap:8px; background:var(--elev); border:1px solid var(--line);
  padding:6px; border-radius:999px; width:max-content
}
.tab{padding:8px 14px; border-radius:999px; cursor:pointer; user-select:none; color:var(--muted)}
.tab.active{background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#081426; font-weight:700}

.grid{display:grid; gap:14px}
@media(min-width:820px){.grid-2{grid-template-columns:1fr 1fr}}

.card{
  background:linear-gradient(180deg,var(--card),#121623);
  border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow)
}
.card h3{margin:0 0 6px}
.kv{color:var(--muted); font-size:13px}
.actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
.tags{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
.tag{font-size:11px; padding:3px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--muted)}
.card.current{outline:2px solid var(--brand)}
.small{font-size:12px; color:var(--muted)}

/* Buttons & inputs */
button,select,input[type="number"],input[type="text"]{
  background:var(--elev); color:var(--ink); border:1px solid var(--line);
  border-radius:12px; padding:10px 12px; font-size:14px; min-height:42px
}
button{cursor:pointer}
.primary{background:linear-gradient(90deg,var(--brand),var(--brand2)); border:none; color:#07142A; font-weight:700}
.ghost{background:transparent}
.warn{background:var(--warn); color:#221a00; border:none}
.success{background:var(--accent); color:#072117; border:none}
.danger{background:var(--danger); border:none}
.block{width:100%}

/* Progress ring (Today) */
.ring{
  width:120px; height:120px; border-radius:50%;
  background:conic-gradient(var(--ring2) var(--p,0%), var(--ring) 0);
  display:grid; place-items:center; border:1px solid var(--line)
}
.ring span{font-weight:800}

/* Timer */
.timer{
  display:grid; gap:10px;
}
.progress{height:12px; background:var(--ring); border-radius:999px; overflow:hidden; border:1px solid var(--line)}
.progress>div{height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2))}

/* Bottom nav (mobile) */
.nav{
  position:fixed; bottom:0; left:0; right:0; backdrop-filter: blur(8px);
  background:rgba(6,8,12,.7); border-top:1px solid var(--line); display:flex; gap:8px; padding:10px 12px; z-index:1000
}
.nav button{flex:1; border-radius:12px}
.nav .active{outline:2px solid var(--brand)}

/* Modals */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:2000; background:rgba(0,0,0,.45)}
.sheet{background:var(--card); border:1px solid var(--line); border-radius:18px; padding:16px; max-width:820px; width:100%; box-shadow:var(--shadow)}
.sheet header{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.sheet h3{margin:0}
.list{max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:12px}
.group{padding:8px 10px; border-bottom:1px solid var(--line)}
.group h4{margin:0 0 6px; font-size:12px; color:var(--muted)}
.list button{display:block; width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:var(--ink)}
.list button:hover{background:rgba(255,255,255,.06)}

/* Settings grid */
.settings-grid{display:grid; grid-template-columns:1fr; gap:10px}
@media(min-width:560px){.settings-grid{grid-template-columns:1fr 1fr}}
@media(min-width:920px){.settings-grid{grid-template-columns:repeat(3,1fr)}}
.settings-grid label{
  display:flex; align-items:center; gap:10px; background:var(--elev);
  border:1px solid var(--line); padding:10px 12px; border-radius:12px; min-height:48px
}
.settings-grid input{transform:scale(1.1)}
.settings-grid label span{flex:1; white-space:normal; overflow-wrap:anywhere; line-height:1.25}

/* Toast */
.toast{position:fixed; left:50%; transform:translateX(-50%); bottom:88px; background:var(--accent); color:#041e15; padding:10px 14px; border-radius:12px; display:none; z-index:3000}

/* Utilities */
.hidden{display:none !important}
.center{display:grid; place-items:center}
.mt8{margin-top:8px}
.mt12{margin-top:12px}
.mt16{margin-top:16px}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="brand"><div class="logo"></div><h1>Alex Pro ‚Äî Hybrid Coach</h1></div>
    <span class="badge" id="themeBadge">Dark</span>
    <div class="spacer"></div>
    <div class="toggle"><input id="themeToggle" type="checkbox"/><span>Light</span></div>
  </div>

  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Primary">
    <div class="tab active" data-tab="today">Today</div>
    <div class="tab" data-tab="program">Program</div>
    <div class="tab" data-tab="session">Session</div>
    <div class="tab" data-tab="settings">Settings</div>
  </div>

  <!-- TODAY -->
  <section id="view-today" class="mt16">
    <div class="grid grid-2">
      <div class="card">
        <h3>Today‚Äôs Focus</h3>
        <div class="kv" id="todayTitle">‚Äî</div>
        <div class="mt12" style="display:flex; align-items:center; gap:14px">
          <div class="ring" id="ring" style="--p:0%"><span id="ringPct">0%</span></div>
          <div>
            <div class="kv">Exercises done: <b id="todayDone">0</b> / <b id="todayTotal">0</b></div>
            <div class="kv mt8">Guided mode: <b id="todayGuided">On</b></div>
            <div class="actions mt12">
              <button class="primary" id="goSession">Start Session</button>
              <button class="ghost" id="goProgram">View Program</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Quick Timer</h3>
        <div class="timer">
          <div class="kv"><b id="timerLabel">Idle</b></div>
          <div class="progress"><div id="bar"></div></div>
          <div style="display:flex; align-items:center; gap:10px">
            <span class="badge timer-big" id="clock">00:00</span>
            <div class="spacer"></div>
            <button id="workBtn" class="success">Work</button>
            <button id="restBtn" class="warn">Rest</button>
            <button id="pauseBtn" class="ghost">Pause</button>
            <button id="resumeBtn" class="ghost">Resume</button>
            <button id="stopBtn" class="ghost">Stop</button>
          </div>
          <div class="row">
            <label>Work(s) <input id="workSecs" type="number" value="45" min="1" style="width:90px"></label>
            <label>Rest(s) <input id="restSecs" type="number" value="60" min="1" style="width:90px"></label>
            <button id="soundToggle" class="ghost">üîî On</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROGRAM -->
  <section id="view-program" class="mt16 hidden">
    <div id="programList" class="grid"></div>
  </section>

  <!-- SESSION -->
  <section id="view-session" class="mt16 hidden">
    <div class="card">
      <h3 id="sessionTitle">Session</h3>
      <div class="kv">Tap ‚ÄúSet done‚Äù to auto-start rest (guided). Use Next/Back to navigate.</div>
      <div id="sessionList" class="grid mt12"></div>
      <div class="actions mt12">
        <button class="ghost" id="prevEx">‚Üê Back</button>
        <button class="primary" id="nextEx">Next ‚Üí</button>
        <button class="danger" id="finishSession">Finish Session</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="view-settings" class="mt16 hidden">
    <div class="card">
      <h3>Equipment</h3>
      <div class="settings-grid" id="equipGrid"></div>
      <div class="actions mt12" style="justify-content:flex-end">
        <button class="primary" id="saveEquip">Save</button>
      </div>
    </div>
    <div class="card">
      <h3>Data</h3>
      <div class="actions">
        <button class="ghost" id="exportBtn">Export</button>
        <button class="ghost" id="importBtn">Import</button>
        <button class="ghost" id="resetBtn">Reset Day</button>
      </div>
    </div>
  </section>
</div>

<!-- Bottom Nav -->
<nav class="nav">
  <button class="ghost" data-tab="today">Today</button>
  <button class="ghost" data-tab="program">Program</button>
  <button class="ghost" data-tab="session">Session</button>
  <button class="ghost" data-tab="settings">Settings</button>
</nav>

<!-- Swap Modal -->
<div class="modal" id="swapModal">
  <div class="sheet">
    <header><h3 id="swapTitle">Swap Exercise</h3><button class="ghost" id="swapClose">‚úï</button></header>
    <div class="chips" id="swapMeta"></div>
    <input id="swapSearch" type="text" placeholder="Search exercise‚Ä¶"/>
    <div class="list" id="swapList"></div>
    <div class="actions" style="justify-content:flex-end">
      <button class="ghost" id="swapRevert">‚Ü©Ô∏é Revert</button>
      <button class="primary" id="swapApply">Apply</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Saved</div>

<script>
/* =================== CORE =================== */
(function(){
  // Utilities
  const LS={get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch(_){return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
  const $=(s)=>document.querySelector(s), $$=(s)=>Array.from(document.querySelectorAll(s));
  const setTxt=(id,t)=>{const e=document.getElementById(id); if(e) e.textContent=t;};
  const val=(id)=>{const e=document.getElementById(id); return e?e.value:'';};
  function toast(msg){const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",1200);}

  // Audio
  let AC=null, sound=LS.get('soundOn',true);
  function beep(f=880,d=0.08,v=60){ if(!sound) return; try{ AC=AC||new (window.AudioContext||window.webkitAudioContext)(); const o=AC.createOscillator(), g=AC.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=v/100; o.connect(g).connect(AC.destination); o.start(); setTimeout(()=>o.stop(), d*1000);}catch(e){} }

  // Plan
  const ex=(name,sets,reps,rest,equip,cat,swaps)=>({name,sets,reps,rest,equip,cat,swaps:swaps||[],originalName:name});
  const PLAN={days:[
    {id:"Day 1 ‚Äî Lower Power",blocks:[
      ex("Back Squat",4,"5",90,["Barbell"],"Squat",["Front Squat","Goblet Squat"]),
      ex("Romanian Deadlift",4,"8",90,["Barbell"],"Hinge",["DB Romanian Deadlift","Good Morning"]),
      ex("Bulgarian Split Squat",3,"10 / leg",60,["Dumbbells","Bodyweight"],"Lunge",["Walking Lunge","Reverse Lunge"]),
      ex("Box Jump",3,"8",60,["Bodyweight"],"Plyo",["Broad Jump","Jump Squat"]),
      ex("Plank",3,"45s",45,["Bodyweight"],"Core: Anti-Ext",["Side Plank","Hollow Hold"]),
    ]},
    {id:"Day 2 ‚Äî Push",blocks:[
      ex("Bench Press",4,"5",120,["Barbell"],"Horizontal Push",["DB Bench Press","Push-Ups"]),
      ex("Overhead Press",4,"6",120,["Barbell"],"Vertical Push",["Landmine Press","Incline Push-Ups"]),
      ex("Dumbbell Incline Press",3,"10",75,["Dumbbells"],"Horizontal Push",["Incline Barbell Press","Push-Ups"]),
      ex("Medicine Ball Slam",4,"8",60,["Med Ball"],"Power Throw",["Kettlebell Swing","Push Press 8"]),
      ex("Battle Rope Waves",4,"20s",40,["Battle Rope"],"Conditioning",["Sled Push","Row Erg Sprint 20s"]),
    ]},
    {id:"Day 3 ‚Äî Conditioning",blocks:[
      ex("Sled Push",6,"20‚Äì30m",60,["Sled/Prowler"],"Conditioning",["Hill Sprint 10‚Äì15s","Row Erg Sprint 20s"]),
      ex("Kettlebell Swing",5,"12",60,["Kettlebell"],"Hinge",["DB Swing","Hip Thrust"]),
      ex("Burpees",4,"10",45,["Bodyweight"],"Conditioning",["Up-Downs (no push-up)","Row 150m Sprint"]),
      ex("Hanging Leg Raise",3,"8‚Äì12",45,["Bodyweight"],"Core: Lats/Hips",["Captains Chair Knee Raise","Lying Leg Raise"]),
      ex("Side Plank",3,"30s / side",30,["Bodyweight"],"Core: Anti-Ext",["Pallof Press Hold","Bird Dog Hold"]),
    ]},
    {id:"Day 4 ‚Äî Pull",blocks:[
      ex("Pull-Ups",5,"AMRAP",120,["Bodyweight"],"Row/Pull",["Chin-Ups","Lat Pulldown"]),
      ex("Bent-Over Barbell Row",4,"6‚Äì8",90,["Barbell"],"Row/Pull",["One-Arm DB Row","Chest-Supported Row"]),
      ex("Seated Cable Row",3,"10",75,["Cable/Machine"],"Row/Pull",["Machine Row","Inverted Row"]),
      ex("Face Pull",3,"12‚Äì15",60,["Cable/Machine","Bands"],"Row/Pull",["Rear Delt Fly","High Row"]),
      ex("Farmer‚Äôs Carry",4,"30‚Äì40m",60,["Dumbbells","Kettlebell","Trap Bar"],"Carry",["Suitcase Carry","Trap Bar Carry"]),
    ]},
    {id:"Day 5 ‚Äî Upper Power",blocks:[
      ex("Jump Squat",4,"6",60,["Bodyweight"],"Plyo",["Box Jump","Broad Jump"]),
      ex("Explosive Push-Ups",4,"5‚Äì6",75,["Bodyweight"],"Horizontal Push",["Clap Push-Ups","DB Bench 10"]),
      ex("Med Ball Overhead Throw",4,"6",75,["Med Ball"],"Power Throw",["MB Slam 10","Push Press 10","Landmine Push Press 8"]),
      ex("KB Clean & Press (each arm)",3,"8/arm",90,["Kettlebell"],"Vertical Push",["DB Clean & Press 8/arm","Push Press 10"]),
      ex("Mountain Climbers",3,"30s",30,["Bodyweight"],"Conditioning",["SkiErg 20s","Row Erg Sprint 20s"]),
    ]},
  ]};
  const DESC={
    "Back Squat":"Bar on upper traps, brace, sit between hips, knees track toes.",
    "Romanian Deadlift":"Hinge; soft knees; bar along thighs; neutral back.",
    "Bulgarian Split Squat":"Back foot up; tall torso; front shin near vertical.",
    "Box Jump":"Load hips & arms, jump softly, stand tall.",
    "Plank":"Elbows under shoulders; ribs down; glutes tight; straight line.",
    "Bench Press":"Feet planted; bar mid-chest; elbows ~45¬∞; press to lockout.",
    "Overhead Press":"From shoulders to overhead; head through; ribs down.",
    "Dumbbell Incline Press":"30‚Äì45¬∞ bench; DBs to chest line; press up.",
    "Medicine Ball Slam":"Reach tall; hinge; drive ball down hard.",
    "Battle Rope Waves":"Athletic stance; quick waves; torso quiet.",
    "Sled Push":"Forward lean; short powerful steps.",
    "Kettlebell Swing":"Hinge; snap hips; bell floats chest height.",
    "Burpees":"Down to plank; back to feet; small jump.",
    "Hanging Leg Raise":"Dead hang; raise legs without swing.",
    "Side Plank":"Feet stacked; elbow under shoulder; hips high.",
    "Pull-Ups":"Overhand; chest to bar; control down.",
    "Bent-Over Barbell Row":"Hinge ~45¬∞; pull to ribs; back flat.",
    "Seated Cable Row":"Tall torso; pull to ribs; squeeze blades.",
    "Face Pull":"Rope to eye line; elbows high; thumbs back.",
    "Farmer‚Äôs Carry":"Heavy bells; tall; brisk walk.",
    "Jump Squat":"Quarter-squat; jump; land soft.",
    "Explosive Push-Ups":"Power push; core tight.",
    "Med Ball Overhead Throw":"Dip then drive up/forward.",
    "KB Clean & Press (each arm)":"Rack clean; press overhead.",
    "Mountain Climbers":"Plank; knees under chest; hips level."
  };

  // State
  const EQUIP_ALL=["Barbell","Dumbbells","Kettlebell","Cable/Machine","Bands","Bodyweight","Med Ball","Sled/Prowler","Battle Rope","Erg/Row/Ski","Landmine"];
  const defaultEquip=Object.fromEntries(EQUIP_ALL.map(e=>[e,true]));
  const state={day:+LS.get('currentDay',0),cursor:0,guided:LS.get('guided',true)};

  // Theme
  function applyTheme(light){document.documentElement.setAttribute('data-theme',light?'light':null);}
  function updateThemeBadge(){$('#themeBadge').textContent=document.documentElement.getAttribute('data-theme')==='light'?'Light':'Dark';}

  // Views
  function setTab(name){
    $$('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===name));
    ['today','program','session','settings'].forEach(v=>{
      $('#view-'+v).classList.toggle('hidden', v!==name);
    });
    $$('.nav button').forEach(b=>b.classList.toggle('active',b.dataset.tab===name));
  }

  // Today
  function renderToday(){
    const day=PLAN.days[state.day], doneMap=LS.get(`pro_done_${state.day}`,{});
    const total=day.blocks.length, done=Object.values(doneMap).filter(x=>x>0).length;
    setTxt('todayTitle', day.id); setTxt('todayDone', done); setTxt('todayTotal', total);
    setTxt('todayGuided', state.guided?'On':'Off');
    const pct = Math.round((done/Math.max(1,total))*100);
    $('#ring').style.setProperty('--p', pct+'%'); setTxt('ringPct', pct+'%');
  }

  // Program
  function renderProgram(){
    const wrap=$("#programList"); wrap.innerHTML='';
    PLAN.days.forEach((d,di)=>{
      const card=document.createElement('div'); card.className='card';
      const tags = `<div class="tags"><span class="tag">Day ${di+1}</span><span class="tag">${d.blocks.length} exercises</span></div>`;
      const rows = d.blocks.map((b,i)=>`
        <div class="mt12" style="border-top:1px dashed var(--line); padding-top:10px">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
            <h3 style="margin:0">${b.name}</h3>
            <button class="ghost" data-action="swap" data-i="${i}" data-di="${di}">Swap</button>
          </div>
          <div class="kv">Sets <b>${b.sets}</b> ‚Ä¢ Reps <b>${b.reps}</b> ‚Ä¢ Rest <b>${b.rest}s</b></div>
          <div class="tags">${[b.cat,...b.equip].map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          <div class="actions">
            <button class="ghost" data-action="tips" data-i="${i}" data-di="${di}">Tips</button>
            <button class="ghost" data-action="note" data-i="${i}" data-di="${di}">Notes</button>
          </div>
        </div>`).join('');
      card.innerHTML = `<h3>${d.id}</h3>${tags}${rows}
        <div class="actions mt12"><button class="primary" data-action="start" data-di="${di}">Start This Day</button></div>`;
      wrap.appendChild(card);
    });
    wrap.onclick=(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const di=+btn.dataset.di, i=+btn.dataset.i;
      if(btn.dataset.action==='start'){ state.day=di; LS.set('currentDay',di); state.cursor=0; renderSession(); setTab('session'); renderToday(); }
      if(btn.dataset.action==='swap'){ openSwap(di,i); }
      if(btn.dataset.action==='tips'){ const b=PLAN.days[di].blocks[i]; alert(`${b.name}\n\n${DESC[b.name]||'No tips yet.'}`); }
      if(btn.dataset.action==='note'){
        const nm=LS.get(`pro_notes_${di}`,{}); const txt=prompt('Note:', nm[i]||''); if(txt!==null){ nm[i]=txt; LS.set(`pro_notes_${di}`,nm); toast('Saved note'); }
      }
    }
  }

  // Session
  function renderSession(){
    const d=PLAN.days[state.day]; setTxt('sessionTitle', d.id);
    const wrap=$("#sessionList"); wrap.innerHTML='';
    const doneMap=LS.get(`pro_done_${state.day}`,{}), notesMap=LS.get(`pro_notes_${state.day}`,{});
    d.blocks.forEach((b,i)=>{
      const cur = state.cursor===i;
      const card=document.createElement('div'); card.className='card'+(cur?' current':'');
      card.innerHTML=`
        <h3>${b.name}</h3>
        <div class="kv">Sets <b id="sets-${i}">${doneMap[i]||0}</b> / ${b.sets} ‚Ä¢ Reps <b>${b.reps}</b> ‚Ä¢ Rest <b>${b.rest}s</b></div>
        <div class="tags">${[b.cat,...b.equip].map(t=>`<span class="tag">${t}</span>`).join('')}</div>
        <div class="actions">
          <button class="success" data-act="set" data-i="${i}">Set done</button>
          <button class="ghost" data-act="swap" data-i="${i}">Swap</button>
          <button class="ghost" data-act="tips" data-i="${i}">Tips</button>
          <button class="ghost" data-act="note" data-i="${i}">Notes</button>
          <span class="small">${notesMap[i]?('üìù '+notesMap[i]):''}</span>
        </div>`;
      wrap.appendChild(card);
    });
    wrap.onclick=(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const i=+btn.dataset.i; const b=PLAN.days[state.day].blocks[i];
      if(btn.dataset.act==='set'){
        const key=`pro_done_${state.day}`; const m=LS.get(key,{});
        const v=Math.min((m[i]||0)+1, b.sets); m[i]=v; LS.set(key,m);
        setTxt('sets-'+i, v); beep(880,0.06);
        if(state.guided){ const r=parseInt(b.rest,10)||60; startTimer(r,'rest'); setTxt('timerLabel',`Rest ${r}s ‚Äî next: ${b.name}`); }
        if(v===b.sets && i===state.cursor) nextEx();
        renderToday();
      }
      if(btn.dataset.act==='swap'){ openSwap(state.day,i); }
      if(btn.dataset.act==='tips'){ alert(`${b.name}\n\n${DESC[b.name]||'No tips yet.'}`); }
      if(btn.dataset.act==='note'){
        const key=`pro_notes_${state.day}`; const nm=LS.get(key,{}); const txt=prompt('Note:', nm[i]||''); if(txt!==null){ nm[i]=txt; LS.set(key,nm); renderSession(); }
      }
    };
  }
  function nextEx(){ const d=PLAN.days[state.day]; state.cursor=Math.min(d.blocks.length-1,state.cursor+1); renderSession(); }
  function prevEx(){ state.cursor=Math.max(0,state.cursor-1); renderSession(); }

  // Smart swap
  function openSwap(di,i){
    const day=PLAN.days[di]; const ex=day.blocks[i];
    const pool = Array.from(new Set(PLAN.days.flatMap(d=>d.blocks.flatMap(b=>[b.name,...(b.swaps||[]),b.originalName])))).filter(Boolean).sort();
    const modal=$("#swapModal"), list=$("#swapList"), search=$("#swapSearch");
    $("#swapTitle").textContent=`Swap "${ex.name}"`;
    $("#swapMeta").innerHTML=`<span class="tag">Pattern: ${ex.cat}</span> ${ex.equip.map(e=>`<span class="tag">${e}</span>`).join(' ')}`;
    modal.style.display='flex';
    const eq=LS.get('equip', defaultEquip);
    function equipOK(n){
      const k=n.toLowerCase(); const rules=[
        ["barbell","Barbell"],["bench","Barbell"],["deadlift","Barbell"],["front squat","Barbell"],
        ["dumbbell","Dumbbells"],[" db","Dumbbells"],
        ["kettlebell","Kettlebell"],[" kb","Kettlebell"],
        ["cable","Cable/Machine"],["machine","Cable/Machine"],["lat pulldown","Cable/Machine"],
        ["band","Bands"],["med ball","Med Ball"],[" mb","Med Ball"],["slam","Med Ball"],["throw","Med Ball"],
        ["sled","Sled/Prowler"],["prowler","Sled/Prowler"],["rope","Battle Rope"],
        ["row erg","Erg/Row/Ski"],["skierg","Erg/Row/Ski"],["erg","Erg/Row/Ski"],["landmine","Landmine"],
        ["push-up","Bodyweight"],["plank","Bodyweight"],["burpee","Bodyweight"],["jump","Bodyweight"],["pull-up","Bodyweight"]
      ];
      for(const [kw,tag] of rules){ if(k.includes(kw)&&!eq[tag]) return false; } return true;
    }
    function cat(n){
      const s=n.toLowerCase();
      if(/(split|lunge)/.test(s))return"Lunge";
      if(/deadlift|rdl|hinge|good morning|swing|hip thrust/.test(s))return"Hinge";
      if(/squat/.test(s)&&!/jump/.test(s))return"Squat";
      if(/row|pull-?up|chin-?up|face pull|lat pulldown/.test(s))return"Row/Pull";
      if(/bench|push-?up|incline|press(?!.*overhead)/.test(s))return"Horizontal Push";
      if(/overhead|push press|clean & press|landmine/.test(s))return"Vertical Push";
      if(/carry/.test(s))return"Carry";
      if(/plank|pallof|hollow|bird dog/.test(s))return"Core: Anti-Ext";
      if(/leg raise/.test(s))return"Core: Lats/Hips";
      if(/box jump|jump squat|broad jump/.test(s))return"Plyo";
      if(/slam|throw/.test(s))return"Power Throw";
      if(/sled|erg|skierg|battle rope|burpee|mountain climber|sprint/.test(s))return"Conditioning";
      return"Conditioning";
    }
    function build(){
      const arr=pool.map(n=>({name:n,cat:cat(n),score:0}));
      arr.forEach(o=>{
        o.score += (o.cat===ex.cat?2:0);
        o.score += equipOK(o.name)?1:-2;
        if(o.name.toLowerCase()===ex.name.toLowerCase()) o.score -= 2;
      });
      arr.sort((a,b)=>b.score-a.score);
      const sugg=arr.filter(o=>o.score>=2).map(o=>o.name);
      const rest=pool.filter(n=>!sugg.includes(n));
      return {sugg,rest};
    }
    const {sugg,rest}=build();
    function draw(q=''){
      list.innerHTML='';
      const group=(t,items)=>{ const g=document.createElement('div'); g.className='group'; g.innerHTML=`<h4>${t}</h4>`;
        items.filter(n=>n.toLowerCase().includes(q.toLowerCase())).forEach(n=>{
          const b=document.createElement('button'); b.textContent=n; b.onclick=()=>sel(n,b); g.appendChild(b);
        }); list.appendChild(g); };
      group("Suggested (pattern + your equipment)",sugg);
      group("All options",rest);
    }
    let chosen=null; function sel(n,btn){ chosen=n; list.querySelectorAll('button').forEach(x=>x.style.background='transparent'); btn.style.background='rgba(255,255,255,.06)'; }
    draw(); search.oninput=()=>draw(search.value);
    $("#swapClose").onclick=()=>modal.style.display='none';
    $("#swapRevert").onclick=()=>{ ex.name=ex.originalName; modal.style.display='none'; renderProgram(); renderSession(); renderToday(); };
    $("#swapApply").onclick=()=>{ if(chosen){ ex.name=chosen; modal.style.display='none'; renderProgram(); renderSession(); }};
  }

  // Timer
  const t={timer:null,remaining:0,total:0,paused:false};
  function startTimer(s,mode){
    stopTimer(); t.remaining=s; t.total=s; t.paused=false;
    setTxt('timerLabel', mode==='work'?'Work running‚Ä¶':`Rest ${s}s`); tick(); t.timer=setInterval(tick,1000);
  }
  function tick(){
    if(t.paused) return;
    if(t.remaining<=0){ stopTimer(); beep(660,0.08); setTimeout(()=>beep(880,0.12,90),120); toast('Rest done ‚Äî go!'); return; }
    t.remaining--; const mm=String(Math.floor(t.remaining/60)).padStart(2,'0'), ss=String(t.remaining%60).padStart(2,'0');
    setTxt('clock',`${mm}:${ss}`); const p=Math.max(0,Math.min(100,100*((t.total-t.remaining)/t.total))); $('#bar').style.width=p+'%';
    if(t.remaining<=3) beep(520+t.remaining*30,0.06);
  }
  function stopTimer(){ if(t.timer) clearInterval(t.timer); t.timer=null; setTxt('clock','00:00'); $('#bar').style.width='0%'; setTxt('timerLabel','Idle'); }

  // Data portability
  function exportData(){
    const data={plan:PLAN, done:collect(/^pro_done_/), notes:collect(/^pro_notes_/), prefs:{day:state.day,guided:state.guided,equip:LS.get('equip',defaultEquip),themeLight:LS.get('themeLight',null),soundOn:LS.get('soundOn',true)}};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='alex_pro_export.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function collect(rx){ const out={}; Object.keys(localStorage).forEach(k=>{ if(rx.test(k)) out[k]=JSON.parse(localStorage.getItem(k));}); return out; }
  function importData(){
    const i=document.createElement('input'); i.type='file'; i.accept='application/json';
    i.onchange=()=>{ const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result);
      if(data.prefs){ Object.entries(data.prefs).forEach(([k,v])=>LS.set(k,v)); }
      if(data.done){ Object.entries(data.done).forEach(([k,v])=>localStorage.setItem(k,JSON.stringify(v))); }
      if(data.notes){ Object.entries(data.notes).forEach(([k,v])=>localStorage.setItem(k,JSON.stringify(v))); }
      toast('Imported'); location.reload();
    }catch(e){ alert('Invalid file'); } }; r.readAsText(f); }; i.click();
  }

  // Boot
  document.addEventListener('DOMContentLoaded', ()=>{
    const pref=LS.get('themeLight',null), sys=matchMedia('(prefers-color-scheme: light)').matches;
    const isLight=pref===null?sys:!!pref; applyTheme(isLight); $('#themeToggle').checked=isLight; updateThemeBadge();
    $('#themeToggle').addEvent
